.\" shlib - A shell library of reusable functions
.TH SHLIB_SYS 3 "February 2026" "shlib 0.4.0" "Shell Library"
.SH NAME
shlib_sys \- System functions from the shlib library
.SH SYNOPSIS
.B source
.I /path/to/shlib.sh
.SH DESCRIPTION
.B shlib_sys
provides functions for system interaction.
Requires Bash version 3 or higher.
.SH FUNCTIONS
.SS Validation
.TP
.BI shlib::cmd_exists " command"
Check if
.I command
exists in PATH. Returns 0 if found, 1 otherwise.
.SS Execution
.TP
.BI shlib::cmd_retry " max_attempts delay command [args...]"
Retry
.I command
up to
.I max_attempts
times with
.I delay
seconds between attempts. Returns 0 if the command succeeds within the allowed
attempts, or 1 if all attempts fail. Set delay to 0 for no delay between retries.
.TP
.BI shlib::cmd_timeout " timeout command [args...]"
Run
.I command
with a timeout specified in seconds. If the command does not complete within
.I timeout
seconds, it is terminated.
Returns the command's exit code if it completes in time, or 124 if it times out.
.SS Locking
.TP
.BI shlib::cmd_locked " lockfile timeout command [args...]"
Run
.I command
protected by a file-based lock. The lock is implemented using
.BR mkdir (1)
which is atomic on POSIX systems, making it portable across platforms.
A directory named
.I lockfile.lock
is created to hold the lock, with a PID file inside for stale lock detection.
.PP
.RS
The
.I timeout
argument controls lock acquisition behavior:
.IP \(bu 2
.B 0
\- Non-blocking; fail immediately if lock is held
.IP \(bu 2
.B >0
\- Wait up to this many seconds to acquire the lock
.IP \(bu 2
.B -1
\- Wait indefinitely until lock is acquired
.RE
.PP
.RS
Stale locks are automatically detected and removed when the process holding the lock
no longer exists.
.RE
.SH EXAMPLES
Check if a command exists:
.PP
.RS
.nf
#!/usr/bin/env bash
source /path/to/shlib/shlib.sh

# Check if a command exists
shlib::cmd_exists "commandname"
.fi
.RE
.PP
Run a command with timeout:
.PP
.RS
.nf
# Timeout after 5 seconds
if shlib::cmd_timeout 5 curl -s http://example.com; then
    echo "Request completed"
else
    echo "Request timed out or failed"
fi
.fi
.RE
.PP
Retry a command on failure:
.PP
.RS
.nf
# Retry up to 3 times with 2 second delay
if shlib::cmd_retry 3 2 curl -f http://example.com; then
    echo "Request succeeded"
else
    echo "Request failed after 3 attempts"
fi
.fi
.RE
.PP
Run a command with file-based locking:
.PP
.RS
.nf
# Non-blocking: fail if another process holds the lock
if shlib::cmd_locked /tmp/myapp 0 ./deploy.sh; then
    echo "Deployment completed"
else
    echo "Another deployment is running"
fi

# Wait up to 30 seconds for the lock
shlib::cmd_locked /tmp/myapp 30 ./critical-section.sh

# Wait forever (useful for cron jobs)
shlib::cmd_locked /var/lock/backup -1 ./backup.sh
.fi
.RE
.SH FILES
.TP
.I examples/sys.sh
Example script demonstrating system functions.
.SH EXIT STATUS
.TP
.B shlib::cmd_exists
Returns 0 if command exists, 1 otherwise.
.TP
.B shlib::cmd_timeout
Returns 0 if command succeeds within timeout, 124 if command times out,
or the command's exit code if it fails before timeout.
.TP
.B shlib::cmd_retry
Returns 0 if command succeeds within max attempts, 1 if all attempts fail.
.TP
.B shlib::cmd_locked
Returns 0 if command succeeds after acquiring lock, 1 if lock could not be acquired
within timeout or arguments are invalid, or the command's exit code otherwise.
.SH SEE ALSO
.BR shlib (7),
.BR shlib_logging (3)
.SH AUTHORS
shlib was created by waltlenu.
.SH LICENSE
MIT License. See LICENSE file for details.
